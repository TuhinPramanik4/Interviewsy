{"version":3,"file":"CivicAuthContext.js","sourceRoot":"","sources":["../../../src/reactjs/providers/CivicAuthContext.tsx"],"names":[],"mappings":"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","sourcesContent":["\"use client\";\nimport React, {\n  createContext,\n  useContext,\n  useEffect,\n  useState,\n  useCallback,\n  useMemo,\n  useRef,\n} from \"react\";\nimport type { ReactNode } from \"react\";\nimport {\n  CivicAuth,\n  AuthEvent,\n  type Session,\n  type User,\n} from \"../../vanillajs/index.js\";\nimport { AuthenticationEvents } from \"../../vanillajs/auth/AuthenticationEvents.js\";\nimport type { DisplayMode, ForwardedTokens } from \"../../types.js\";\nimport { extractTokensFromSession } from \"../../vanillajs/utils/auth-utils.js\";\n\n// Event payload interfaces\ninterface SignInErrorEvent {\n  detail: string;\n}\n\nexport type AuthStatusEnum =\n  | \"authenticated\"\n  | \"unauthenticated\"\n  | \"authenticating\"\n  | \"error\"\n  | \"signing_out\";\n\nexport interface CivicAuthContextType {\n  // Core auth instance\n  auth: CivicAuth | null;\n\n  // User and session state\n  user: User | null;\n  session: Session | null;\n\n  // Auth state\n  isLoading: boolean;\n  authStatus: AuthStatusEnum;\n  error: Error | null;\n\n  // Tokens\n  idToken?: string;\n  accessToken?: string;\n  refreshToken?: string;\n  forwardedTokens?: ForwardedTokens;\n\n  // Auth methods\n  signIn: () => Promise<{ user: User }>;\n  signOut: () => Promise<void>;\n\n  // Config\n  displayMode?: DisplayMode;\n}\n\nconst CivicAuthContext = createContext<CivicAuthContextType | null>(null);\n\nexport interface CivicAuthContextProviderProps {\n  children: ReactNode;\n  clientId: string;\n  redirectUrl?: string;\n  oauthServerBaseUrl?: string;\n  scopes?: string[];\n  displayMode?: DisplayMode;\n  iframeDisplayMode?: \"modal\" | \"embedded\";\n  onSignIn?: (error?: Error) => void;\n  onSignOut?: () => void;\n  nonce?: string;\n  authProcessTimeout?: number;\n}\n\nexport const CivicAuthContextProvider: React.FC<\n  CivicAuthContextProviderProps\n> = ({\n  children,\n  clientId,\n  redirectUrl,\n  oauthServerBaseUrl = \"https://auth.civic.com/oauth/\",\n  scopes = [\"openid\", \"profile\", \"email\", \"offline_access\"],\n  displayMode = \"iframe\",\n  iframeDisplayMode = \"modal\",\n  onSignIn,\n  onSignOut,\n  nonce,\n  authProcessTimeout = 120000,\n}) => {\n  const [auth, setAuth] = useState<CivicAuth | null>(null);\n  const [user, setUser] = useState<User | null>(null);\n  const [session, setSession] = useState<Session | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [authStatus, setAuthStatus] =\n    useState<AuthStatusEnum>(\"unauthenticated\");\n  const [error, setError] = useState<Error | null>(null);\n\n  // Track initialization to prevent double-execution in React StrictMode\n  const initializationRef = useRef<{\n    isInitializing: boolean;\n    isInitialized: boolean;\n  }>({\n    isInitializing: false,\n    isInitialized: false,\n  });\n\n  useEffect(() => {\n    let isMounted = true;\n\n    // Prevent double initialization in React StrictMode\n    if (\n      initializationRef.current.isInitializing ||\n      initializationRef.current.isInitialized\n    ) {\n      // `[CivicAuthContext] Skipping initialization ${initId} - already initializing/initialized`,\n\n      return;\n    }\n\n    // Capture ref value at effect setup time for cleanup\n    const initializationState = initializationRef.current;\n\n    initializationRef.current.isInitializing = true;\n\n    const refreshUserAndSession = async () => {\n      if (!auth) return;\n\n      try {\n        const currentSession = await auth.getCurrentSession();\n        const currentUser = await auth.getCurrentUser();\n\n        if (isMounted) {\n          setSession(currentSession);\n          setUser(currentUser);\n        }\n      } catch (err) {\n        if (isMounted) {\n          const sessionError =\n            err instanceof Error ? err : new Error(\"Failed to get session\");\n          setError(sessionError);\n        }\n      }\n    };\n\n    const initializeAuth = async () => {\n      try {\n        const events = new AuthenticationEvents();\n\n        // Set up event listeners\n        events.on(AuthEvent.SIGN_IN_STARTED, () => {\n          if (isMounted) {\n            setIsLoading(true);\n            setAuthStatus(\"authenticating\");\n            setError(null);\n          }\n        });\n\n        events.on(AuthEvent.SIGN_IN_COMPLETE, () => {\n          if (isMounted) {\n            setIsLoading(false);\n            setAuthStatus(\"authenticated\");\n            setError(null);\n            onSignIn?.();\n          }\n        });\n\n        events.on(AuthEvent.SIGN_IN_ERROR, (event?: SignInErrorEvent) => {\n          if (isMounted) {\n            setIsLoading(false);\n            setAuthStatus(\"error\");\n            const errorDetail = event?.detail || \"Authentication failed\";\n            const authError = new Error(errorDetail);\n            setError(authError);\n            onSignIn?.(authError);\n          }\n        });\n\n        events.on(AuthEvent.SIGN_OUT_STARTED, () => {\n          if (isMounted) {\n            setIsLoading(true);\n            setAuthStatus(\"signing_out\");\n            setError(null);\n          }\n        });\n\n        events.on(AuthEvent.SIGN_OUT_COMPLETE, () => {\n          if (isMounted) {\n            setIsLoading(false);\n            setAuthStatus(\"unauthenticated\");\n            setUser(null);\n            setSession(null);\n            setError(null);\n            onSignOut?.();\n          }\n        });\n\n        events.on(AuthEvent.USER_SESSION_CHANGED, () => {\n          if (isMounted) {\n            refreshUserAndSession();\n          }\n        });\n\n        const authInstance = await CivicAuth.create({\n          clientId,\n          redirectUrl:\n            redirectUrl ||\n            `${window.location.origin}${window.location.pathname}`,\n          oauthServerBaseUrl,\n          scopes,\n          displayMode,\n          iframeDisplayMode,\n          nonce,\n          authProcessTimeout,\n          events,\n        });\n\n        if (isMounted) {\n          setAuth(authInstance);\n\n          // Mark initialization as complete\n          initializationRef.current.isInitializing = false;\n          initializationRef.current.isInitialized = true;\n\n          // Check initial auth state\n          const isAuthenticated = await authInstance.isAuthenticated();\n          if (isAuthenticated) {\n            setAuthStatus(\"authenticated\");\n            await refreshUserAndSession();\n          } else {\n            setAuthStatus(\"unauthenticated\");\n\n            // Pre-load iframe for iframe display mode to match old behavior\n            // This prepares the iframe in the background so it's ready to be shown\n            if (displayMode === \"iframe\") {\n              try {\n                // Pre-load by setting iframe display mode - this doesn't show it but prepares it\n                authInstance.setIframeDisplayMode(iframeDisplayMode);\n              } catch (err) {\n                // Don't fail initialization if iframe pre-loading fails\n                console.warn(\"Iframe pre-loading failed:\", err);\n              }\n            }\n          }\n\n          // Mark initialization as complete\n          setIsLoading(false);\n        }\n      } catch (err) {\n        console.error(err);\n        if (isMounted) {\n          const initError =\n            err instanceof Error ? err : new Error(\"Failed to initialize auth\");\n          setError(initError);\n          setAuthStatus(\"error\");\n          setIsLoading(false); // Stop loading even on error\n\n          // Mark initialization as failed\n          initializationRef.current.isInitializing = false;\n          // Don't mark as initialized on error so it can be retried\n        }\n      }\n    };\n\n    initializeAuth();\n\n    return () => {\n      isMounted = false;\n\n      // Reset initialization guards to allow remount to reinitialize\n      // This is necessary for React StrictMode compatibility\n      if (initializationState.isInitializing) {\n        initializationState.isInitializing = false;\n        initializationState.isInitialized = false;\n      }\n\n      if (auth) {\n        auth.destroy();\n      }\n    };\n    // Refresh user and session when auth instance changes\n    /*\n     * Intentionally omitting dependencies to prevent infinite loops.\n     * Adding auth, onSignIn, onSignOut, and scopes to the dependency array would cause\n     * the effect to re-run whenever these values change, which could lead to unnecessary\n     * re-renders and potential infinite loops since the effect updates state that might\n     * trigger re-renders of parent components.\n     *\n     * IMPORTANT: redirectUrl is intentionally omitted to prevent re-initialization\n     * during OAuth callback when URL parameters change, which would cause\n     * \"invalid_grant\" errors due to authorization code reuse.\n     */\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [\n    clientId,\n    oauthServerBaseUrl,\n    displayMode,\n    iframeDisplayMode,\n    nonce,\n    authProcessTimeout,\n  ]);\n\n  // This is on load to get the user and session\n  useEffect(() => {\n    if (auth && authStatus === \"authenticated\") {\n      const refreshUserAndSession = async () => {\n        try {\n          const currentSession = await auth.getCurrentSession();\n          const currentUser = await auth.getCurrentUser();\n          setSession(currentSession);\n          setUser(currentUser);\n        } catch (err) {\n          const sessionError =\n            err instanceof Error ? err : new Error(\"Failed to get session\");\n          setError(sessionError);\n        }\n      };\n\n      refreshUserAndSession();\n    }\n  }, [auth, authStatus]);\n\n  const signIn = useCallback(async () => {\n    if (!auth) {\n      // If auth is still loading, provide a more helpful error\n      if (isLoading) {\n        throw new Error(\"Authentication is still initializing, please wait...\");\n      }\n      throw new Error(\"Auth not initialized\");\n    }\n\n    try {\n      const { user } = await auth.startAuthentication();\n\n      // Refresh user and session after successful authentication\n      const currentSession = await auth.getCurrentSession();\n\n      setSession(currentSession);\n      setUser(user ?? null);\n\n      // Ensure we have a user to return\n      if (!user) {\n        throw new Error(\"Authentication succeeded but no user was returned\");\n      }\n\n      // Return the user object\n      return { user };\n    } catch (err) {\n      const signInError =\n        err instanceof Error ? err : new Error(\"Sign in failed\");\n      setError(signInError);\n      throw signInError;\n    }\n  }, [auth, isLoading]);\n\n  const signOut = useCallback(async () => {\n    if (!auth) {\n      // If auth is still loading, provide a more helpful error\n      if (isLoading) {\n        throw new Error(\"Authentication is still initializing, please wait...\");\n      }\n      throw new Error(\"Auth not initialized\");\n    }\n\n    try {\n      await auth.logout();\n      setUser(null);\n      setSession(null);\n    } catch (err) {\n      const signOutError =\n        err instanceof Error ? err : new Error(\"Sign out failed\");\n      setError(signOutError);\n      throw signOutError;\n    }\n  }, [auth, isLoading]);\n\n  // Extract tokens from session\n  const idToken = session?.idToken;\n  const accessToken = session?.accessToken;\n  const refreshToken = session?.refreshToken;\n\n  // Extract forwardedTokens from session's ID token\n  const forwardedTokens = useMemo(() => {\n    if (!session) return undefined;\n    const tokens = extractTokensFromSession(session);\n    return tokens.forwardedTokens;\n  }, [session]);\n\n  const contextValue: CivicAuthContextType = useMemo(\n    () => ({\n      auth,\n      user,\n      session,\n      isLoading,\n      authStatus,\n      error,\n      idToken,\n      accessToken,\n      refreshToken,\n      forwardedTokens,\n      signIn,\n      signOut,\n      displayMode,\n    }),\n    [\n      auth,\n      user,\n      session,\n      isLoading,\n      authStatus,\n      error,\n      idToken,\n      accessToken,\n      refreshToken,\n      forwardedTokens,\n      signIn,\n      signOut,\n      displayMode,\n    ],\n  );\n\n  return (\n    <CivicAuthContext.Provider value={contextValue}>\n      {children}\n    </CivicAuthContext.Provider>\n  );\n};\n\nexport const useCivicAuthContext = (): CivicAuthContextType => {\n  const context = useContext(CivicAuthContext);\n  if (!context) {\n    throw new Error(\n      \"useCivicAuthContext must be used within a CivicAuthContextProvider\",\n    );\n  }\n  return context;\n};\n\nexport { CivicAuthContext };\n"]}